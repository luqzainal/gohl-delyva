import{r as o,j as e,a as U}from"./client-DCNturwH.js";const J=()=>{const[i,h]=o.useState(""),[d,E]=o.useState(""),[u,T]=o.useState(""),[g,P]=o.useState(""),[p,D]=o.useState(""),[m,k]=o.useState(""),[r,f]=o.useState(""),[y,x]=o.useState(!1),[b,v]=o.useState(""),[O,j]=o.useState(""),[c,S]=o.useState(!0),[w,C]=o.useState(!1);o.useEffect(()=>{const t=()=>{fetch("/api/find-integrated-location",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({attempted_location_id:"initial_load",timestamp:new Date().toISOString()})}).then(a=>a.json()).then(a=>{if(a.location_id){f(a.location_id),console.log("Found integrated location:",a.location_id);return}s()}).catch(a=>{console.error("Error finding integrated location:",a),s()})},s=()=>{const a=()=>{window.parent.postMessage({message:"REQUEST_USER_DATA"},"*")},N=I=>{if(I.data?.message==="REQUEST_USER_DATA_RESPONSE"){const K=I.data.payload;fetch("/api/decrypt-context",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({encryptedData:K})}).then(l=>l.json()).then(l=>{f(l.locationId),console.log("HighLevel Context:",l)}).catch(l=>{console.error("Error decrypting context:",l),f("test_location_dev")})}};window.addEventListener("message",N),setTimeout(a,100),setTimeout(()=>{window.removeEventListener("message",N)},1e4)};t()},[]),o.useEffect(()=>{r&&A()},[r]);const A=async()=>{if(r)try{const t=await fetch(`/api/carrier/status/${r}`);if(t.ok){const s=await t.json();S(s.status?.shipping_enabled??!0)}}catch(t){console.error("Error loading shipping status:",t)}},n=(t,s)=>{v(t),j(s),setTimeout(()=>{v(""),j("")},5e3)},L=async()=>{if(!i){n("Please enter your Delyva API Key","error");return}C(!0);try{const t=await fetch("/api/credentials/test",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({locationId:r,apiKey:i,customerId:d,apiSecret:u,companyCode:g,companyId:p,userId:m})}),s=await t.json();t.ok&&s.valid===!0?n("✅ Delyva credentials are valid!","success"):n(`❌ ${s.message||s.error_details||"Invalid credentials"}`,"error")}catch(t){n("❌ Error testing credentials","error"),console.error("Test credentials error:",t)}finally{C(!1)}},_=async t=>{if(!r){n("Location ID not found. Please refresh the page.","error");return}try{const s=await fetch("/api/shipping/toggle",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({locationId:r,enabled:t})}),a=await s.json();s.ok&&a.status==="success"?(S(t),n(t?"✅ Shipping rates enabled!":"⏸️ Shipping rates disabled!","success")):n(`❌ ${a.error||"Failed to update shipping status"}`,"error")}catch(s){n("❌ Error updating shipping status. Please try again.","error"),console.error("Toggle shipping error:",s)}},R=async()=>{if(!r){console.log("Cannot register carrier - no location ID");return}try{const t=await fetch(`/api/carrier/register/${r}`,{method:"POST",headers:{"Content-Type":"application/json"}}),s=await t.json();t.ok?(n("✅ Registered as shipping carrier in HighLevel!","success"),console.log("Carrier registration successful:",s)):console.error("Carrier registration failed:",s)}catch(t){console.error("Carrier registration error:",t)}},$=async t=>{if(t.preventDefault(),!i){n("Please enter your Delyva API Key","error");return}if(!r){n("Location ID not found. Please refresh the page.","error");return}x(!0);try{const s=await fetch("/api/credentials",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({locationId:r,apiKey:i,customerId:d,apiSecret:u,companyCode:g,companyId:p,userId:m})}),a=await s.json();s.ok&&a.status==="success"?(n("🎉 API Key saved successfully!","success"),R()):n(`❌ ${a.error||"Failed to save credentials"}`,"error")}catch(s){n("❌ Error saving credentials. Please try again.","error"),console.error("Save credentials error:",s)}finally{x(!1)}};return e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-md bg-white rounded-lg shadow-md p-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Delyva Integration"}),e.jsx("p",{className:"text-gray-600 text-sm",children:"Enter your Delyva credentials to enable shipping"}),r&&e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["Location: ",r]})]}),b&&e.jsx("div",{className:`mb-4 p-3 rounded-md text-sm ${O==="success"?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200"}`,children:b}),e.jsxs("form",{onSubmit:$,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Delyva API Key *"}),e.jsx("input",{type:"text",value:i,onChange:t=>h(t.target.value),placeholder:"Enter your Delyva API Key",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer ID (Optional)"}),e.jsx("input",{type:"text",value:d,onChange:t=>E(t.target.value),placeholder:"Customer ID (will auto-detect if empty)",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"API Secret (Optional)"}),e.jsx("input",{type:"password",value:u,onChange:t=>T(t.target.value),placeholder:"API Secret (if available)",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Company Code"}),e.jsx("input",{type:"text",value:g,onChange:t=>P(t.target.value),placeholder:"e.g., demo",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Company ID"}),e.jsx("input",{type:"text",value:p,onChange:t=>D(t.target.value),placeholder:"e.g., 9e0aed8a-5c67-42a4-82b6-e01bf7687f31",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"User ID"}),e.jsx("input",{type:"text",value:m,onChange:t=>k(t.target.value),placeholder:"e.g., 3e21a1c0-912e-11f0-b030-1bfc12908131",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{type:"button",onClick:L,disabled:w||!i,className:"flex-1 bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 disabled:opacity-50 disabled:cursor-not-allowed text-sm",children:w?"Testing...":"Test Credentials"}),e.jsx("button",{type:"submit",disabled:y||!i||!r,className:"flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed text-sm",children:y?"Saving...":"Save"})]})]}),r&&e.jsx("div",{className:"mt-6 p-4 bg-gray-50 rounded-lg border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-900",children:"Live Shipping Rates"}),e.jsx("p",{className:"text-xs text-gray-600 mt-1",children:c?"Customers will see live shipping rates at checkout":"Shipping rates are disabled - no rates will be shown"})]}),e.jsx("button",{onClick:()=>_(!c),className:`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 ${c?"bg-blue-600":"bg-gray-200"}`,role:"switch","aria-checked":c,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white shadow-lg transition-transform ${c?"translate-x-6":"translate-x-1"}`})})]})}),e.jsx("div",{className:"mt-6 text-xs text-gray-500 text-center",children:e.jsx("p",{children:"After saving, Delyva will be registered as a shipping carrier in HighLevel."})})]})})};document.addEventListener("DOMContentLoaded",()=>{const i=document.getElementById("plugin-root");i?U.createRoot(i).render(e.jsx(J,{})):console.error("Plugin root element not found")});
