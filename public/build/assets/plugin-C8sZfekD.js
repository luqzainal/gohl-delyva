import{r as n,j as t,a as A}from"./client-DCNturwH.js";const k=()=>{const[o,g]=n.useState(""),[d,S]=n.useState(""),[u,w]=n.useState(""),[r,p]=n.useState(""),[h,m]=n.useState(!1),[f,y]=n.useState(""),[N,x]=n.useState(""),[c,b]=n.useState(!0),[v,j]=n.useState(!1);n.useEffect(()=>{const e=()=>{window.parent.postMessage({message:"REQUEST_USER_DATA"},"*")},s=i=>{if(i.data?.message==="REQUEST_USER_DATA_RESPONSE"){const D=i.data.payload;fetch("/api/decrypt-context",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({encryptedData:D})}).then(l=>l.json()).then(l=>{p(l.locationId),console.log("HighLevel Context:",l)}).catch(l=>{console.error("Error decrypting context:",l),p("test_location_dev")})}};return window.addEventListener("message",s),setTimeout(e,100),()=>window.removeEventListener("message",s)},[]),n.useEffect(()=>{r&&E()},[r]);const E=async()=>{if(r)try{const e=await fetch(`/api/carrier/status/${r}`);if(e.ok){const s=await e.json();b(s.status?.shipping_enabled??!0)}}catch(e){console.error("Error loading shipping status:",e)}},a=(e,s)=>{y(e),x(s),setTimeout(()=>{y(""),x("")},5e3)},C=async()=>{if(!o){a("Please enter your Delyva API Key","error");return}j(!0);try{const e=await fetch("/api/credentials/test",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({locationId:r,apiKey:o,customerId:d,apiSecret:u})}),s=await e.json();e.ok&&s.valid===!0?a("✅ Delyva credentials are valid!","success"):a(`❌ ${s.message||s.error_details||"Invalid credentials"}`,"error")}catch(e){a("❌ Error testing credentials","error"),console.error("Test credentials error:",e)}finally{j(!1)}},T=async e=>{if(!r){a("Location ID not found. Please refresh the page.","error");return}try{const s=await fetch("/api/shipping/toggle",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({locationId:r,enabled:e})}),i=await s.json();s.ok&&i.status==="success"?(b(e),a(e?"✅ Shipping rates enabled!":"⏸️ Shipping rates disabled!","success")):a(`❌ ${i.error||"Failed to update shipping status"}`,"error")}catch(s){a("❌ Error updating shipping status. Please try again.","error"),console.error("Toggle shipping error:",s)}},P=async()=>{if(!r){console.log("Cannot register carrier - no location ID");return}try{const e=await fetch(`/api/carrier/register/${r}`,{method:"POST",headers:{"Content-Type":"application/json"}}),s=await e.json();e.ok?(a("✅ Registered as shipping carrier in HighLevel!","success"),console.log("Carrier registration successful:",s)):console.error("Carrier registration failed:",s)}catch(e){console.error("Carrier registration error:",e)}},I=async e=>{if(e.preventDefault(),!o){a("Please enter your Delyva API Key","error");return}if(!r){a("Location ID not found. Please refresh the page.","error");return}m(!0);try{const s=await fetch("/api/credentials",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({locationId:r,apiKey:o,customerId:d,apiSecret:u})}),i=await s.json();s.ok&&i.status==="success"?(a("🎉 API Key saved successfully!","success"),P()):a(`❌ ${i.error||"Failed to save credentials"}`,"error")}catch(s){a("❌ Error saving credentials. Please try again.","error"),console.error("Save credentials error:",s)}finally{m(!1)}};return t.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center p-4",children:t.jsxs("div",{className:"w-full max-w-md bg-white rounded-lg shadow-md p-6",children:[t.jsxs("div",{className:"text-center mb-6",children:[t.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Delyva Integration"}),t.jsx("p",{className:"text-gray-600 text-sm",children:"Enter your Delyva credentials to enable shipping"}),r&&t.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["Location: ",r]})]}),f&&t.jsx("div",{className:`mb-4 p-3 rounded-md text-sm ${N==="success"?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200"}`,children:f}),t.jsxs("form",{onSubmit:I,className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Delyva API Key *"}),t.jsx("input",{type:"text",value:o,onChange:e=>g(e.target.value),placeholder:"Enter your Delyva API Key",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer ID (Optional)"}),t.jsx("input",{type:"text",value:d,onChange:e=>S(e.target.value),placeholder:"Customer ID (will auto-detect if empty)",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"API Secret (Optional)"}),t.jsx("input",{type:"password",value:u,onChange:e=>w(e.target.value),placeholder:"API Secret (if available)",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),t.jsxs("div",{className:"flex space-x-3",children:[t.jsx("button",{type:"button",onClick:C,disabled:v||!o,className:"flex-1 bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 disabled:opacity-50 disabled:cursor-not-allowed text-sm",children:v?"Testing...":"Test Credentials"}),t.jsx("button",{type:"submit",disabled:h||!o||!r,className:"flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed text-sm",children:h?"Saving...":"Save"})]})]}),r&&t.jsx("div",{className:"mt-6 p-4 bg-gray-50 rounded-lg border",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("h3",{className:"text-sm font-medium text-gray-900",children:"Live Shipping Rates"}),t.jsx("p",{className:"text-xs text-gray-600 mt-1",children:c?"Customers will see live shipping rates at checkout":"Shipping rates are disabled - no rates will be shown"})]}),t.jsx("button",{onClick:()=>T(!c),className:`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 ${c?"bg-blue-600":"bg-gray-200"}`,role:"switch","aria-checked":c,children:t.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white shadow-lg transition-transform ${c?"translate-x-6":"translate-x-1"}`})})]})}),t.jsx("div",{className:"mt-6 text-xs text-gray-500 text-center",children:t.jsx("p",{children:"After saving, Delyva will be registered as a shipping carrier in HighLevel."})})]})})};document.addEventListener("DOMContentLoaded",()=>{const o=document.getElementById("plugin-root");o?A.createRoot(o).render(t.jsx(k,{})):console.error("Plugin root element not found")});
