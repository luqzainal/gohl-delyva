import{r as n,j as e,a as K}from"./client-DCNturwH.js";const U=()=>{const[o,y]=n.useState(""),[p,I]=n.useState(""),[g,E]=n.useState(""),[m,T]=n.useState(""),[f,P]=n.useState(""),[h,D]=n.useState(""),[r,u]=n.useState(""),[x,b]=n.useState(!1),[v,j]=n.useState(""),[_,S]=n.useState(""),[c,w]=n.useState(!0),[N,C]=n.useState(!1);n.useEffect(()=>{const t=()=>{window.parent.postMessage({message:"REQUEST_USER_DATA"},"*")},s=i=>{if(i.data?.message==="REQUEST_USER_DATA_RESPONSE"){const $=i.data.payload;fetch("/api/decrypt-context",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({encryptedData:$})}).then(l=>l.json()).then(l=>{u(l.locationId),console.log("HighLevel Context:",l)}).catch(l=>{console.error("Error decrypting context:",l),fetch("/api/find-integrated-location",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({attempted_location_id:"context_decrypt_failed",timestamp:new Date().toISOString()})}).then(d=>d.json()).then(d=>{d.location_id?(u(d.location_id),console.log("Found integrated location:",d.location_id)):u("test_location_dev")}).catch(()=>{u("test_location_dev")})})}};return window.addEventListener("message",s),setTimeout(t,100),()=>window.removeEventListener("message",s)},[]),n.useEffect(()=>{r&&k()},[r]);const k=async()=>{if(r)try{const t=await fetch(`/api/carrier/status/${r}`);if(t.ok){const s=await t.json();w(s.status?.shipping_enabled??!0)}}catch(t){console.error("Error loading shipping status:",t)}},a=(t,s)=>{j(t),S(s),setTimeout(()=>{j(""),S("")},5e3)},O=async()=>{if(!o){a("Please enter your Delyva API Key","error");return}C(!0);try{const t=await fetch("/api/credentials/test",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({locationId:r,apiKey:o,customerId:p,apiSecret:g,companyCode:m,companyId:f,userId:h})}),s=await t.json();t.ok&&s.valid===!0?a("âœ… Delyva credentials are valid!","success"):a(`âŒ ${s.message||s.error_details||"Invalid credentials"}`,"error")}catch(t){a("âŒ Error testing credentials","error"),console.error("Test credentials error:",t)}finally{C(!1)}},A=async t=>{if(!r){a("Location ID not found. Please refresh the page.","error");return}try{const s=await fetch("/api/shipping/toggle",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({locationId:r,enabled:t})}),i=await s.json();s.ok&&i.status==="success"?(w(t),a(t?"âœ… Shipping rates enabled!":"â¸ï¸ Shipping rates disabled!","success")):a(`âŒ ${i.error||"Failed to update shipping status"}`,"error")}catch(s){a("âŒ Error updating shipping status. Please try again.","error"),console.error("Toggle shipping error:",s)}},L=async()=>{if(!r){console.log("Cannot register carrier - no location ID");return}try{const t=await fetch(`/api/carrier/register/${r}`,{method:"POST",headers:{"Content-Type":"application/json"}}),s=await t.json();t.ok?(a("âœ… Registered as shipping carrier in HighLevel!","success"),console.log("Carrier registration successful:",s)):console.error("Carrier registration failed:",s)}catch(t){console.error("Carrier registration error:",t)}},R=async t=>{if(t.preventDefault(),!o){a("Please enter your Delyva API Key","error");return}if(!r){a("Location ID not found. Please refresh the page.","error");return}b(!0);try{const s=await fetch("/api/credentials",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({locationId:r,apiKey:o,customerId:p,apiSecret:g,companyCode:m,companyId:f,userId:h})}),i=await s.json();s.ok&&i.status==="success"?(a("ðŸŽ‰ API Key saved successfully!","success"),L()):a(`âŒ ${i.error||"Failed to save credentials"}`,"error")}catch(s){a("âŒ Error saving credentials. Please try again.","error"),console.error("Save credentials error:",s)}finally{b(!1)}};return e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-md bg-white rounded-lg shadow-md p-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Delyva Integration"}),e.jsx("p",{className:"text-gray-600 text-sm",children:"Enter your Delyva credentials to enable shipping"}),r&&e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["Location: ",r]})]}),v&&e.jsx("div",{className:`mb-4 p-3 rounded-md text-sm ${_==="success"?"bg-green-100 text-green-700 border border-green-200":"bg-red-100 text-red-700 border border-red-200"}`,children:v}),e.jsxs("form",{onSubmit:R,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Delyva API Key *"}),e.jsx("input",{type:"text",value:o,onChange:t=>y(t.target.value),placeholder:"Enter your Delyva API Key",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer ID (Optional)"}),e.jsx("input",{type:"text",value:p,onChange:t=>I(t.target.value),placeholder:"Customer ID (will auto-detect if empty)",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"API Secret (Optional)"}),e.jsx("input",{type:"password",value:g,onChange:t=>E(t.target.value),placeholder:"API Secret (if available)",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Company Code"}),e.jsx("input",{type:"text",value:m,onChange:t=>T(t.target.value),placeholder:"e.g., demo",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Company ID"}),e.jsx("input",{type:"text",value:f,onChange:t=>P(t.target.value),placeholder:"e.g., 9e0aed8a-5c67-42a4-82b6-e01bf7687f31",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"User ID"}),e.jsx("input",{type:"text",value:h,onChange:t=>D(t.target.value),placeholder:"e.g., 3e21a1c0-912e-11f0-b030-1bfc12908131",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{type:"button",onClick:O,disabled:N||!o,className:"flex-1 bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 disabled:opacity-50 disabled:cursor-not-allowed text-sm",children:N?"Testing...":"Test Credentials"}),e.jsx("button",{type:"submit",disabled:x||!o||!r,className:"flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed text-sm",children:x?"Saving...":"Save"})]})]}),r&&e.jsx("div",{className:"mt-6 p-4 bg-gray-50 rounded-lg border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-900",children:"Live Shipping Rates"}),e.jsx("p",{className:"text-xs text-gray-600 mt-1",children:c?"Customers will see live shipping rates at checkout":"Shipping rates are disabled - no rates will be shown"})]}),e.jsx("button",{onClick:()=>A(!c),className:`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 ${c?"bg-blue-600":"bg-gray-200"}`,role:"switch","aria-checked":c,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white shadow-lg transition-transform ${c?"translate-x-6":"translate-x-1"}`})})]})}),e.jsx("div",{className:"mt-6 text-xs text-gray-500 text-center",children:e.jsx("p",{children:"After saving, Delyva will be registered as a shipping carrier in HighLevel."})})]})})};document.addEventListener("DOMContentLoaded",()=>{const o=document.getElementById("plugin-root");o?K.createRoot(o).render(e.jsx(U,{})):console.error("Plugin root element not found")});
